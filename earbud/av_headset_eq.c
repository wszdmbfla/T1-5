/*
 *
 *
 *   Add this file for Euqualizer
 *   support OTA update EQ data
 *
 *
*/

#include <panic.h>
#include <ps.h>
#include <boot.h>
#include <input_event_manager.h>

#include "av_headset.h"
#include "av_headset_log.h"
#include "av_headset_eq.h"


#if defined(INCLUDE_EQ)

extern uint8 earbudVersion[];

/********************************************************************
Accord to customer EQ modes  ,change  CUSTOMER_EQ_MODE_MAX value & set g_audio_eq0~g_audio_eq4 EQ data
customer supply EQ.htf
Exp:
# PSID=0x2488, capID=0x0049, UCID=0x0004
# -> [ 1001 0000 002C 0000 0000 0000 0000 0000 000A FFC0 0000 0000 000D 0002 0000 FFE0 0000 00B5 C28F 0000 000D 0004 0000 FFE0 0000 00B5 C28F 0000 000D 0007 D000 FFE0 0000 00B5 C28F 0000 000D 000F A000 FFE0 0000 00B5 C28F 0000 000D 001F 4000 FFE0 0000 00B5 C28F 0000 000D 003E 8000 FFE0 0000 00B5 C28F 0000 000D 007D 0000 FFE0 0000 00B5 C28F 0000 000D 00FA 0000 0000 0000 00B5 C28F 0000 000D 01F4 0000 0000 0000 00B5 C28F 0000 000D 03E8 0000 0000 0000 00B5 C28F  ]
0x002480 = [ 01 10 00 00 2C 00 00 00 00 00 00 00 00 00 00 00 0A 00 C0 FF 00 00 00 00 0D 00 02 00 00 00 E0 FF 00 00 B5 00 8F C2 00 00 0D 00 04 00 00 00 E0 FF 00 00 B5 00 8F C2 00 00 0D 00 07 00 00 D0 E0 FF 00 00 B5 00 8F C2 00 00 0D 00 0F 00 00 A0 E0 FF 00 00 B5 00 8F C2 00 00 0D 00 1F 00 00 40 E0 FF 00 00 B5 00 8F C2 00 00 0D 00 3E 00 00 80 E0 FF 00 00 B5 00 8F C2 00 00 0D 00 7D 00 00 00 E0 FF 00 00 B5 00 8F C2 00 00 0D 00 FA 00 00 00 00 00 00 00 B5 00 8F C2 00 00 0D 00 F4 01 00 00 00 00 00 00 B5 00 8F C2 00 00 0D 00 E8 03 00 00 00 00 00 00 B5 00 8F C2 ]
********************************************************************/
#define CUSTOMER_EQ_MODE_MAX  5
/* POP */
uint8  g_audio_eq0[]={0x01,0x10,0x00,0x00,0x2C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0D,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04,0x00,0x00,0x0D,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04,0x00,0x00,0x0D,0x00,0x07,0x00,0x00,0xD0,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04,0x00,0x00,0x0D,0x00,0x0F,0x00,0x00,0xA0,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04,0x00,0x00,0x0D,0x00,0x1F,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04,0x00,0x00,0x0D,0x00,0x3E,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04,0x00,0x00,0x0D,0x00,0x7D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04,0x00,0x00,0x0D,0x00,0xFA,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04,0x00,0x00,0x0D,0x00,0xF4,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04,0x00,0x00,0x0D,0x00,0xE8,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0xF4,0x04};
/* Rap */
uint8  g_audio_eq1[]={0x01,0x10,0x00,0x00,0x2C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0x00,0xD0,0xFF,0x00,0x00,0x00,0x00,0x0D,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x04,0x00,0x00,0x00,0xC0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x07,0x00,0x00,0xD0,0xB0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x0F,0x00,0x00,0xA0,0xD0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x1F,0x00,0x00,0x40,0x10,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x3E,0x00,0x00,0x80,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x7D,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xFA,0x00,0x00,0x00,0xD0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xF4,0x01,0x00,0x00,0xE0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xE8,0x03,0x00,0x00,0xD0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2};
/* country */
uint8  g_audio_eq2[]={0x01,0x10,0x00,0x00,0x2C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0x00,0xB0,0xFF,0x00,0x00,0x00,0x00,0x0D,0x00,0x02,0x00,0x00,0x00,0x60,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x04,0x00,0x00,0x00,0xC0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x07,0x00,0x00,0xD0,0x00,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x0F,0x00,0x00,0xA0,0xA0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x1F,0x00,0x00,0x40,0xD0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x3E,0x00,0x00,0x80,0x50,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x7D,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xFA,0x00,0x00,0x00,0xD0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xF4,0x01,0x00,0x00,0x20,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xE8,0x03,0x00,0x00,0x10,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2};
/* Rock */
uint8  g_audio_eq3[]={0x01,0x10,0x00,0x00,0x2C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0x00,0xE0,0xFF,0x00,0x00,0x00,0x00,0x0D,0x00,0x02,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x04,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x07,0x00,0x00,0xD0,0xE0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x0F,0x00,0x00,0xA0,0xC0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x1F,0x00,0x00,0x40,0x80,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x3E,0x00,0x00,0x80,0x80,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x7D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xFA,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xF4,0x01,0x00,0x00,0x10,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xE8,0x03,0x00,0x00,0x10,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2};
/* Jazz */
//uint8  g_audio_eq4[]={0x01,0x10,0x00,0x00,0x2C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0x00,0xD0,0xFF,0x00,0x00,0x00,0x00,0x0D,0x00,0x02,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x04,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x07,0x00,0x00,0xD0,0xC0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x0F,0x00,0x00,0xA0,0xA0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x1F,0x00,0x00,0x40,0x60,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x3E,0x00,0x00,0x80,0x80,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x7D,0x00,0x00,0x00,0xE0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xFA,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xF4,0x01,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xE8,0x03,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2};
uint8  g_audio_eq4[]={0x01,0x10,0x00,0x00,0x2C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0x00,0xC0,0xFF,0x00,0x00,0x00,0x00,0x0D,0x00,0x02,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x04,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x07,0x00,0x00,0xD0,0xC0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x0F,0x00,0x00,0xA0,0xA0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x1F,0x00,0x00,0x40,0x60,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x3E,0x00,0x00,0x80,0x80,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0x7D,0x00,0x00,0x00,0xE0,0xFF,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xFA,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xF4,0x01,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2,0x00,0x00,0x0D,0x00,0xE8,0x03,0x00,0x00,0x30,0x00,0x00,0x00,0xB5,0x00,0x8F,0xC2};

/**********************************************************************/

static bool app_ui_EQ_translate(uint16* buff,const uint8* eq_data)
{
   uint8 i;
   uint8 count,count1;

   for(i =0;i<AUDIO_EQ_DATA_LEN;i++){
       count=2*i;
       count1=count+1;
       buff[i]=eq_data[count]|(eq_data[count1]<<8);
   }

   return TRUE;
}


void lhtdebugfunc(void)
{
    uint16 w_buf[91]={0};
    app_ui_EQ_translate(w_buf,g_audio_eq0);
}

/*
    check software version and EQ verify times
uint8 earbudVersion[] = "5.2.0";
*/

bool appEQupdateVerifyPStore(void)
{
    uint16 ps_data[4]={0};
    uint16 Pskey_valid = 0;
    bool result = FALSE;

    Pskey_valid = PsRetrieve(PS_USER_EQ_VERIFY,ps_data,0);
    if(Pskey_valid){
        PsRetrieve(PS_USER_EQ_VERIFY, ps_data, 4);

        if((ps_data[0]== earbudVersion[0])&&(ps_data[1]== earbudVersion[2])&&(ps_data[2]== earbudVersion[4])&&(ps_data[3] >= PS_EQ_VERIFY_TIMES_MAX)){
            DEBUG_LOG("Current SW version verify more than max timers,Dont't update");
            result = TRUE;
        }
        else{
            DEBUG_LOGF("appEQupdateVerifyPStore V %x.%x.%x,timers:%d",ps_data[0],ps_data[1],ps_data[2],ps_data[3]);
            result = FALSE;
        }
    }
    else{
        DEBUG_LOG("appEQupdateVerifyPStore PSKEY isn't exit, init ");
        memset(ps_data,0,sizeof(ps_data));
        PsStore(PS_USER_EQ_VERIFY, ps_data,4);
        result = FALSE;
    }

    return result;
}



static void appEqPStoreUpdate(bool user_clean)
{
    uint16 ps_data[4]={0};

    PsRetrieve(PS_USER_EQ_VERIFY, ps_data, 4);
    if((ps_data[0]== earbudVersion[0])&&(ps_data[1]== earbudVersion[2])&&(ps_data[2]== earbudVersion[4])){
        if(ps_data[3]<PS_EQ_VERIFY_TIMES_MAX){
            ps_data[3] +=1;
        }
        else{
            ps_data[3] = 0;
        }
    }
    else{
        ps_data[0] = earbudVersion[0];
        ps_data[1] = earbudVersion[2];
        ps_data[2] = earbudVersion[4];
        ps_data[3] = 1;
    }
    DEBUG_LOGF("appEqPStoreUpdate %02x,%02x,%02x,%d,clean:%d",ps_data[0],ps_data[1],ps_data[2],ps_data[3],user_clean);

    if(user_clean){
       ps_data[3] = 0;
    }
    PsStore(PS_USER_EQ_VERIFY, ps_data,4);
}

static bool appEqDataCompare(const uint16* buf1,const uint16* buf2,uint16 length)
{
    uint16 i;
    /*
    uint16 b1_lenght =sizeof(buf1)/sizeof(buf1[0]);
    uint16 b2_lenght =sizeof(buf2)/sizeof(buf2[0]);

    if((b1_lenght<length)||(b2_lenght<length)){
        DEBUG_LOGF("appEqDataCompare lenght error b1:%d,b2:%d,length:%d",b1_lenght,b2_lenght,length);
        return FALSE;
    }
    */
    for(i=0;i<length;i++){
        if(buf1[i] != buf2[i])
            return FALSE;
    }
    return TRUE;
}

static bool app_ui_audio_eq_data_update(void)
{
   uint16 write_result = 0;
   uint32 pskey_value = 0;
   uint16 read_buf[92]={0};
   uint16 read_result = 0;
   uint16 w_buf[91]={0};
   uint8 update_result = 0;
   uint8 i;


   for(i=0;i<CUSTOMER_EQ_MODE_MAX;i++){
       DEBUG_LOGF("app_ui_audio_eq_data_update i:%d",i);

       switch(i){
           case 0:
               pskey_value=AUDIO_EQ_MODE0_KEY;
               if(AUDIO_EQ_WRITE_ARRAY_LEN != (sizeof(g_audio_eq0)/sizeof(g_audio_eq0[0]))){
                   DEBUG_LOG("app_ui_audio_eq_data_update EQ data length error !!!");
                   return FALSE;
               }
               app_ui_EQ_translate(w_buf,g_audio_eq0);

           break;

           case 1:
               pskey_value=AUDIO_EQ_MODE1_KEY;
               if(FALSE == app_ui_EQ_translate(w_buf,g_audio_eq1))
                   return FALSE;
           break;

           case 2:
               pskey_value=AUDIO_EQ_MODE2_KEY;
               if(FALSE == app_ui_EQ_translate(w_buf,g_audio_eq2))
                   return FALSE;
           break;

           case 3:
               pskey_value=AUDIO_EQ_MODE3_KEY;
               if(FALSE == app_ui_EQ_translate(w_buf,g_audio_eq3))
                   return FALSE;
           break;

           case 4:
               pskey_value=AUDIO_EQ_MODE4_KEY;
               if(FALSE == app_ui_EQ_translate(w_buf,g_audio_eq4))
                   return FALSE;
           break;

       default:
            DEBUG_LOG("app_ui_audio_eq_data_update data error");
           break;
       }
       read_result= PsReadAudioKey(pskey_value,read_buf,92,0,0);

       DEBUG_LOG("app_ui_audio_eq_data_update read_result:%d",read_result);
       if(read_result != AUDIO_EQ_DATA_LEN){
           DEBUG_LOG("app_ui_audio_eq_data_update PsReadAudioKey read data len is Error OR it's first read,but key is empty");
           //update_result = 0;
           //return error?
       }

       if(appEqDataCompare(read_buf,w_buf,AUDIO_EQ_DATA_LEN)){
           DEBUG_LOG("app_ui_audio_eq_data_update This EQ data Don't need update");
           update_result += 1;
           continue;
       }
       else{
          write_result = PsUpdateAudioKey(pskey_value,w_buf,91,0,91);
          if(write_result != AUDIO_EQ_DATA_LEN){
           DEBUG_LOG("app_ui_audio_eq_data_update Write error!!!!");
           update_result = 0;
          }
          else{
              memset(read_buf,0,sizeof(read_buf));
              read_result= PsReadAudioKey(pskey_value,read_buf,92,0,0);
              if((read_result == AUDIO_EQ_DATA_LEN)&& appEqDataCompare(read_buf,w_buf,AUDIO_EQ_DATA_LEN)){
              /* write success 1 Eq data*/
                update_result+=1;
              }
              else{
                DEBUG_LOG("app_ui_audio_eq_data_update Write fail??????");
              }
          }
       }
  }
   DEBUG_LOG("EQ update times:%d",update_result);
   if(update_result == CUSTOMER_EQ_MODE_MAX){
       return TRUE;
   }
   else
       return FALSE;
}


/*
     verify EQ0 last 8 EQ data  & PSkey is less than 3times
     PS_key: PS_USER_EQ_VERIFY    2 * uint16
        version number + EQ data verify times
exp:    5.2.0    + count (count max tiemrs : )   0x5205

*/
bool app_ui_audio_eq_update_need_update(void)
{

    if(appEQupdateVerifyPStore()){
        DEBUG_LOG("app_ui_audio_eq_update_need_update ignore");
    }
    else{
        if(app_ui_audio_eq_data_update()){
          appEqPStoreUpdate(0);
        }
        else{
          appEqPStoreUpdate(1);
        }
    }
    return FALSE;
}


#endif
